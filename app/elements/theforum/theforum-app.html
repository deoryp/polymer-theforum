<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="theforum-app">
  <template>
    <style include="shared-styles"></style>
    <style include="theforum-theme"></style>
    
    
    <style is="custom-style">
      .skinny {
        max-width: 300px;
      }
      .wide {
        right: 0;
        left: 0;
      }
      .tight {
        margin: 0px;
      }
    
      paper-fab {
        position: absolute;
        bottom: 18px;
        right: 18px;
        z-index: 100;
      }
      
      paper-button {
        display: block;
        margin-bottom: 24px;
      }
      paper-button.blue {
        color: #fff;
        background: var(--paper-blue-500);
        --paper-button-flat-focus-color: var(--paper-blue-400);
      }
      paper-button.blue:hover {
        background: var(--paper-blue-400);
      }
    </style>
    
    <paper-fab 
        id="compose"
        on-click="_composePost" 
        icon="add"
        hidden$="{{!_showComposePost(authenticated, route, composable)}}"></paper-fab>
    
    <paper-dialog
        id="composePostDialog"
        class="wide"
        on-iron-overlay-opened="_composePostDialogOpened"
        on-iron-overlay-closed="_composePostDialogClosed"
        modal>
    
    <paper-material
        class="tight"
        animated 
        elevation="3">
      <theforum-post-compose2 
          topic="[[route]]"
          user="[[user]]"
          on-posted="_userPosted"></theforum-post-compose2>
    </paper-material>

      </paper-dialog>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>OK</paper-button>
      </div>
    </paper-dialog>
    
    <paper-drawer-panel drawer-width="175px" id="paperDrawerPanel">
  
      <!-- Drawer Scroll Header Panel -->
      <paper-scroll-header-panel drawer fixed>
        <!-- Drawer Toolbar -->
        <paper-toolbar id="drawerToolbar">
          <span class="paper-font-title">Menu</span>
        </paper-toolbar>
        <!-- Drawer Content -->
        <paper-menu
            attr-for-selected="data-route"
            selected="[[route]]">
          <template is="dom-repeat" items="{{unauthenticatedTopics()}}">
            <a data-route$="{{item.route}}" 
                href="{{item.href}}" 
                on-click="onDataRouteClick" 
                disabled$="{{item.disabled}}"
                hidden$="{{authenticated}}">
              <iron-icon icon="{{item.icon}}"></iron-icon>
              <span>{{item.title}}</span>
            </a>
          </template>
          <template is="dom-repeat" items="{{authenticatedTopics()}}">
            <a data-route$="{{item.route}}" 
                href="{{item.href}}" 
                on-click="onDataRouteClick" 
                disabled$="{{item.disabled}}"
                hidden$="{{!authenticated}}">
              <iron-icon icon="{{item.icon}}"></iron-icon>
              <span>{{item.title}}</span>
            </a>
          </template>
          <a on-click="logout" 
              hidden$="{{!authenticated}}">
            <iron-icon icon="account-circle"></iron-icon>
            <span>Logout</span>
          </a>
        </paper-menu>
      </paper-scroll-header-panel>
      
      <!-- Main Area -->
      <paper-scroll-header-panel main condenses keep-condensed-header>

        <!-- Main Toolbar -->
        <paper-toolbar id="mainToolbar" class="tall">
          <paper-icon-button id="paperToggle" icon="menu" paper-drawer-toggle></paper-icon-button>
          <span class="flex"></span>

          <!-- Toolbar icons -->
          <theforum-user id="user" user="{{user}}" authenticated="{{authenticated}}"></theforum-user>

          <!-- Application name -->
          <div class="middle middle-container center horizontal layout">
            <div class="app-name">THE FORUM v4.1</div>
          </div>

          <!-- Application sub title -->
          <div class="bottom bottom-container center horizontal layout">
            <div class="bottom-title paper-font-subhead">This is where we hang out.</div>
          </div>

        </paper-toolbar>

        <!-- Main Content -->
        <div class="content">
          <iron-pages attr-for-selected="data-route" selected="{{route}}">
            
            <section data-route="login">
              <paper-material class="skinny" animated elevation="1">
                <h3>Please login.</h3>
                <p>You will be directed to a Google sign in prompt, then redirected back here.</p>
                <paper-button class="blue" raised on-click="login">
                  <iron-icon icon="input"></iron-icon> Sign in
                </paper-button>
              </paper-material>
            </section>

            <section data-route="fresh">
              <paper-material animated elevation="1">
                <h2 class="page-title">This will be the FRESH area.</h2>
              </paper-material>
            </section>

            <section data-route="general">
                <theforum-topic topic="general" user="{{user}}"></theforum-general>
            </section>

            <section data-route="media">
              <theforum-topic topic="media" user="{{user}}"></theforum-general>
            </section>

            <section data-route="events">
              <paper-material elevation="1">
                <h2 class="page-title">This will be the EVENTS area.</h2>
              </paper-material>
            </section>

            <section data-route="contacts">
              <paper-material elevation="1">
                <h2 class="page-title">This will be the CONTACTS area.</h2>
              </paper-material>
            </section>

          </iron-pages>
        </div>
      
      </paper-scroll-header-panel>
    </paper-drawer-panel>
  </template>
  <script>
    Polymer({
      is: 'theforum-app',
      properties: {
        composable: {
          type: Boolean,
          value: true
        }
      },
      _showComposePost: function (authenticated, route, composable) {
        if (authenticated && composable) {
          if (route === 'general') {
            return true;
          } else if (route === 'media') {
            return true;
          }
        }
        return false;
      },
      _composePost: function() {
        console.log('here. ' + this.route);
        
        var dialog = document.getElementById('composePostDialog');
        dialog.open();
        
        this.composable = false;
      },

      _composePostDialogOpened: function() {
        console.log('opened.');
      },

      _composePostDialogClosed: function(e) {
        console.log('closed.');
        console.log(e);
        this.composable = true;
      },


      isAuthenticated: function(user) {
        if (user && user.isAuthenticated) {
          return user.isAuthenticated();
        }
        return false;
      },
      authenticatedTopics: function() {
        var topics = [];
        topics.push({route: 'fresh', href:'/', icon:'home', title:'Home'});
        topics.push({route: 'general', href:'/general', icon:'question-answer', title:'General'});
        topics.push({route: 'media', href:'/media', icon:'theaters', title:'Media'});
        topics.push({route: 'events', href:'/events', icon:'event', title:'Events', disabled:true});
        topics.push({route: 'contacts', href:'/contacts', icon:'communication:contacts',
            title:'Rolodex', disabled:true});
        return topics;
      },
      unauthenticatedTopics: function() {
        var topics = [];
        topics.push({route: 'login', href:'/login', icon:'account-circle', title:'Login'});
        return topics;
      },
      login: function() {
        window.location  = '/auth/google';
      },
      logout: function() {
        var cookie = document.querySelector('theforum-cookie');
        cookie.removeToken();
        window.location  = '/';
      },
      sortThread: function(a, b) {
        var aAt = new Date(a.updated || a.modifed || a.created).getTime();
        var bAt = new Date(b.updated || b.modifed || b.created).getTime();
        if (aAt === bAt) {
          return 0;
        }
        return aAt < bAt ? -1 : 1;
      }
    });
    
    
  </script>
</dom-module>