<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="theforum-actions">
  <template>
    <theforum-cookie id="cookie"></theforum-cookie>
    <iron-ajax
        id="ajax"
        headers='{{_headers()}}'
        handle-as="json"
        on-response="_handleResponse"></iron-ajax>
    <paper-toast id="toast" text="This is a toast!"></paper-toast>
  </template>
  <script>

    Polymer({
      is: 'theforum-actions',
      
      properties: {
        pending: {
          type: Boolean,
          value: false
        }
      },

      _headers: function() {
        var token = this.$.cookie.token;
        return {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        };
      },
      createThread: function(detail, callback) {
        var that = this;
        if (this.pending) {
          callback({success:false, message:'actionPending'});
        }
        this.pending = true;
        this.$.ajax.url = '/api/thread/' + detail.topic;
        this.$.ajax.method = 'POST';
        this.$.ajax.body = JSON.stringify({
          title: detail.title,
          markdown: detail.markdown
        });
        
        this.$.ajax.addEventListener('response', function(event) {
          that.pending = false;
          that.$.toast.text = 'Thread created for ' + detail.topic +'.';
          that.$.toast.show();
          callback(event);
        });
        this.$.ajax.generateRequest();
        this.$.toast.show();
      },
      deleteThread: function(detail, callback) {
        var that = this;
        if (this.pending) {
          callback({success:false, message:'actionPending'});
        }
        this.pending = true;
        this.$.ajax.url = '/api/thread/' + detail.topic + '/' + detail.threadId;
        this.$.ajax.method = 'DELETE';
        this.$.ajax.body = '';
        this.$.ajax.addEventListener('response', function(event) {
          that.pending = false;
          that.$.toast.text = 'Thread deleted out of ' + detail.topic +'.';
          that.$.toast.show();
          callback(event);
        });
        this.$.ajax.generateRequest();
      }
    });
  </script>
</dom-module>